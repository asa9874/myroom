<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°€êµ¬ ì¶”ì²œ ì•Œë¦¼ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .status.disconnected {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }

        .status.connected {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
        }

        .notifications {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
        }

        .notification-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .notification-item.success {
            border-left: 4px solid #4caf50;
        }

        .notification-item.failed {
            border-left: 4px solid #f44336;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .notification-type {
            font-weight: 600;
            color: #333;
        }

        .notification-time {
            font-size: 12px;
            color: #999;
        }

        .notification-body {
            color: #555;
            font-size: 14px;
            line-height: 1.6;
        }

        .notification-body strong {
            color: #333;
        }

        .logs {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        .log-entry .timestamp {
            color: #80deea;
        }

        .log-entry .level-info {
            color: #4fc3f7;
        }

        .log-entry .level-success {
            color: #66bb6a;
        }

        .log-entry .level-error {
            color: #ef5350;
        }

        .log-entry .level-warn {
            color: #ffca28;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .user-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .user-info p {
            margin-bottom: 5px;
            color: #555;
        }

        .user-info strong {
            color: #333;
        }

        /* ì¶”ì²œ ê²°ê³¼ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .recommendation-container {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .room-analysis {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .room-analysis h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .analysis-item {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .analysis-item-label {
            font-size: 12px;
            color: #999;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .analysis-item-value {
            font-size: 16px;
            color: #333;
            font-weight: 600;
        }

        .detected-furniture {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .furniture-tag {
            background: #667eea;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .recommendation-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .recommendation-info h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .recommendation-info p {
            color: #555;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .search-query {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 6px;
            color: #666;
            font-size: 13px;
            margin-bottom: 10px;
            border-left: 3px solid #667eea;
        }

        .reasoning {
            background: #e8f4f8;
            padding: 12px;
            border-radius: 6px;
            color: #1565c0;
            font-size: 13px;
            line-height: 1.6;
            border-left: 3px solid #1565c0;
            margin-bottom: 10px;
        }

        /* ì¶”ì²œ ê°€êµ¬ ì¹´ë“œ ê·¸ë¦¬ë“œ */
        .furniture-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .furniture-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .furniture-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .furniture-card-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            background: #f5f5f5;
        }

        .furniture-card-body {
            padding: 12px;
        }

        .furniture-rank {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .furniture-score {
            display: block;
            color: #999;
            font-size: 11px;
            margin-bottom: 6px;
        }

        .furniture-name {
            font-size: 13px;
            color: #333;
            font-weight: 600;
            word-break: break-word;
        }

        .no-recommendations {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .no-recommendations svg {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›‹ï¸ ê°€êµ¬ ì¶”ì²œ AI ì‹œìŠ¤í…œ</h1>
            <p>WebSocketì„ í†µí•œ ì‹¤ì‹œê°„ ì¶”ì²œ ì•Œë¦¼ í…ŒìŠ¤íŠ¸</p>
        </div>

        <div class="content">
            <!-- ë¡œê·¸ì¸ ì„¹ì…˜ -->
            <div class="section" id="loginSection">
                <h2>ğŸ” ë¡œê·¸ì¸</h2>
                <div class="form-group">
                    <label for="email">ì´ë©”ì¼</label>
                    <input type="email" id="email" placeholder="test@example.com" value="test@example.com">
                </div>
                <div class="form-group">
                    <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" value="password123">
                </div>
                <button onclick="login()">ë¡œê·¸ì¸</button>
            </div>

            <!-- ì‚¬ìš©ì ì •ë³´ ì„¹ì…˜ -->
            <div class="section" id="userInfoSection" style="display: none;">
                <h2>ğŸ‘¤ ì‚¬ìš©ì ì •ë³´</h2>
                <div class="user-info">
                    <p><strong>íšŒì› ID:</strong> <span id="userId">-</span></p>
                    <p><strong>ì´ë©”ì¼:</strong> <span id="userEmail">-</span></p>
                    <p><strong>í† í°:</strong> <span id="userToken" style="word-break: break-all; font-size: 11px;">-</span></p>
                </div>
                <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <!-- WebSocket ì—°ê²° ì„¹ì…˜ -->
            <div class="section" id="websocketSection" style="display: none;">
                <h2>ğŸ”Œ WebSocket ì—°ê²°</h2>
                <div id="connectionStatus" class="status disconnected">
                    âš« ì—°ê²° ëŠê¹€
                </div>
                <div class="button-group">
                    <button onclick="connectWebSocket()" id="connectBtn">WebSocket ì—°ê²°</button>
                    <button onclick="disconnectWebSocket()" id="disconnectBtn" disabled>ì—°ê²° ëŠê¸°</button>
                    <button onclick="sendPing()" id="pingBtn" disabled>Ping ì „ì†¡</button>
                </div>
            </div>

            <!-- ì¶”ì²œ ìš”ì²­ ì„¹ì…˜ -->
            <div class="section" id="recommendSection" style="display: none;">
                <h2>ğŸ¨ ê°€êµ¬ ì¶”ì²œ ìš”ì²­</h2>
                <div class="form-group">
                    <label for="imageFile">ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ</label>
                    <input type="file" id="imageFile" accept="image/*" style="padding: 8px;">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="category">ê°€êµ¬ ì¹´í…Œê³ ë¦¬</label>
                        <select id="category">
                            <option value="chair">ì˜ì (Chair)</option>
                            <option value="table">í…Œì´ë¸” (Table)</option>
                            <option value="lamp">ì¡°ëª… (Lamp)</option>
                            <option value="sofa">ì†ŒíŒŒ (Sofa)</option>
                            <option value="desk">ì±…ìƒ (Desk)</option>
                            <option value="shelf">ì„ ë°˜ (Shelf)</option>
                            <option value="bed">ì¹¨ëŒ€ (Bed)</option>
                            <option value="cabinet">ìºë¹„ë‹› (Cabinet)</option>
                            <option value="refrigerator">ëƒ‰ì¥ê³  (Refrigerator)</option>
                            <option value="furniture">ê°€êµ¬ (General)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="topK">ì¶”ì²œ ê²°ê³¼ ê°œìˆ˜</label>
                        <select id="topK">
                            <option value="3">3ê°œ</option>
                            <option value="5" selected>5ê°œ</option>
                            <option value="10">10ê°œ</option>
                            <option value="15">15ê°œ</option>
                        </select>
                    </div>
                </div>
                <div id="uploadStatus" style="margin: 15px 0;"></div>
                <button onclick="requestRecommendation()" id="recommendBtn">ì´ë¯¸ì§€ ë¶„ì„ ë° ì¶”ì²œ ìš”ì²­</button>
            </div>

            <!-- ì¶”ì²œ ê²°ê³¼ ì„¹ì…˜ -->
            <div class="section" id="resultSection" style="display: none;">
                <h2>âœ¨ ì¶”ì²œ ê²°ê³¼</h2>
                <div id="resultContent"></div>
            </div>

            <!-- ì•Œë¦¼ ìˆ˜ì‹  ì„¹ì…˜ -->
            <div class="section" id="notificationSection" style="display: none;">
                <h2>ğŸ”” ìˆ˜ì‹ ëœ ì•Œë¦¼ (<span id="notificationCount">0</span>)</h2>
                <button onclick="clearNotifications()" style="margin-bottom: 15px;">ì•Œë¦¼ ì§€ìš°ê¸°</button>
                <div class="notifications" id="notifications">
                    <p style="color: #999; text-align: center;">ìˆ˜ì‹ ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </div>

            <!-- ë¡œê·¸ ì„¹ì…˜ -->
            <div class="section">
                <h2>ğŸ“‹ ë¡œê·¸</h2>
                <button onclick="clearLogs()" style="margin-bottom: 15px;">ë¡œê·¸ ì§€ìš°ê¸°</button>
                <div class="logs" id="logs"></div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let stompClient = null;
        let token = null;
        let userId = null;
        let notificationCount = 0;
        const SERVER_URL = 'http://localhost:8080';

        // ë¡œê·¸ í•¨ìˆ˜
        function log(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> <span class="level-${level}">[${level.toUpperCase()}]</span> ${message}`;
            
            const logsDiv = document.getElementById('logs');
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        // JWT í† í°ì—ì„œ Payload ë””ì½”ë”©
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                log('âŒ JWT íŒŒì‹± ì‹¤íŒ¨: ' + e.message, 'error');
                return null;
            }
        }

        // ë¡œê·¸ì¸
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                alert('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            log(`ë¡œê·¸ì¸ ì‹œë„: ${email}`, 'info');

            try {
                const response = await fetch(`${SERVER_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    log('ğŸ“¦ ë¡œê·¸ì¸ ì‘ë‹µ ë°ì´í„°: ' + JSON.stringify(data), 'info');
                    
                    token = data.token || data.accessToken || data.jwtToken;
                    
                    if (!token) {
                        log('âŒ í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: í† í°ì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    // JWTì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
                    const jwtPayload = parseJwt(token);
                    log('ğŸ”“ JWT Payload: ' + JSON.stringify(jwtPayload), 'info');
                    
                    let userEmail = email;
                    
                    if (jwtPayload) {
                        userId = jwtPayload.id || jwtPayload.userId || jwtPayload.memberId || jwtPayload.sub;
                        userEmail = jwtPayload.sub || jwtPayload.email || email;
                    }
                    
                    if (!userId) {
                        userId = data.userId || data.id || data.memberId || data.member_id;
                    }
                    
                    log('ğŸ”‘ ì¶”ì¶œëœ í† í°: ' + (token ? 'ìˆìŒ' : 'ì—†ìŒ'), 'info');
                    log('ğŸ‘¤ ì¶”ì¶œëœ userId: ' + userId, 'info');
                    log('ğŸ“§ ì¶”ì¶œëœ email: ' + userEmail, 'info');
                    
                    if (!userId) {
                        log('âš ï¸ userIdë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. JWT Payloadë¥¼ í™•ì¸í•˜ì„¸ìš”.', 'error');
                        alert('ë¡œê·¸ì¸ì€ ì„±ê³µí–ˆìœ¼ë‚˜ ì‚¬ìš©ì IDë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.');
                        return;
                    }

                    log('âœ… ë¡œê·¸ì¸ ì„±ê³µ', 'success');
                    log(`íšŒì› ID: ${userId}`, 'info');

                    // UI ì—…ë°ì´íŠ¸
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('userInfoSection').style.display = 'block';
                    document.getElementById('websocketSection').style.display = 'block';
                    document.getElementById('recommendSection').style.display = 'block';
                    document.getElementById('notificationSection').style.display = 'block';

                    document.getElementById('userId').textContent = userId;
                    document.getElementById('userEmail').textContent = userEmail;
                    document.getElementById('userToken').textContent = token;

                } else {
                    const error = await response.text();
                    log(`âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error}`, 'error');
                    alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error);
                }
            } catch (error) {
                log(`âŒ ë¡œê·¸ì¸ ì˜¤ë¥˜: ${error.message}`, 'error');
                alert('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
            }
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            if (stompClient && stompClient.connected) {
                disconnectWebSocket();
            }

            token = null;
            userId = null;
            
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('userInfoSection').style.display = 'none';
            document.getElementById('websocketSection').style.display = 'none';
            document.getElementById('recommendSection').style.display = 'none';
            document.getElementById('notificationSection').style.display = 'none';
            document.getElementById('resultSection').style.display = 'none';

            log('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ', 'info');
        }

        // ì¶”ì²œ ìš”ì²­
        async function requestRecommendation() {
            const fileInput = document.getElementById('imageFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            if (!token) {
                alert('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.');
                return;
            }

            if (!file.type.startsWith('image/')) {
                alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }

            const category = document.getElementById('category').value;
            const topK = parseInt(document.getElementById('topK').value);

            log(`ğŸ“¤ ì¶”ì²œ ìš”ì²­ ì‹œì‘: ${file.name} (${(file.size / 1024).toFixed(2)} KB), category=${category}, topK=${topK}`, 'info');

            const recommendBtn = document.getElementById('recommendBtn');
            const uploadStatus = document.getElementById('uploadStatus');

            recommendBtn.disabled = true;
            uploadStatus.innerHTML = '<p style="color: #1565c0;">â³ ë¶„ì„ ì¤‘...</p>';

            try {
                // FormData ìƒì„±
                const formData = new FormData();
                formData.append('image', file);

                // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ categoryì™€ topK ì¶”ê°€
                const url = new URL(`${SERVER_URL}/api/recommand/request`);
                url.searchParams.append('category', category);
                url.searchParams.append('topK', topK);

                // API í˜¸ì¶œ
                const response = await fetch(url.toString(), {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (response.ok) {
                    const responseMessage = await response.text();
                    
                    log('âœ… ì¶”ì²œ ìš”ì²­ ì„±ê³µ', 'success');
                    log(`ì„œë²„ ì‘ë‹µ: ${responseMessage}`, 'info');
                    
                    uploadStatus.innerHTML = `
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">
                            <p style="color: #2e7d32; font-weight: 600; margin-bottom: 5px;">âœ… ì¶”ì²œ ìš”ì²­ ì „ì†¡ ì„±ê³µ!</p>
                            <p style="color: #555; font-size: 14px;">ğŸ”„ ê°€êµ¬ ì¶”ì²œ ë¶„ì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ì—ì„œ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                        </div>
                    `;

                    // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
                    fileInput.value = '';

                    // ê²°ê³¼ ì„¹ì…˜ ì¤€ë¹„
                    const resultSection = document.getElementById('resultSection');
                    const resultContent = document.getElementById('resultContent');
                    
                    resultContent.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="display: inline-block;">
                                <div style="font-size: 48px; margin-bottom: 20px;">â³</div>
                                <p style="color: #666; font-size: 16px; font-weight: 600;">ë¶„ì„ ì§„í–‰ ì¤‘...</p>
                                <p style="color: #999; font-size: 14px; margin-top: 10px;">AIê°€ ë°©ì„ ë¶„ì„í•˜ê³  ê°€êµ¬ë¥¼ ì¶”ì²œí•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    `;
                    resultSection.style.display = 'block';

                    if (!stompClient || !stompClient.connected) {
                        uploadStatus.innerHTML += `
                            <div style="background: #fff3e0; padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800; margin-top: 10px;">
                                <p style="color: #e65100; font-weight: 600;">âš ï¸ WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!</p>
                                <p style="color: #555; font-size: 14px;">ê²°ê³¼ë¥¼ ë°›ìœ¼ë ¤ë©´ WebSocketì„ ì—°ê²°í•˜ì„¸ìš”.</p>
                            </div>
                        `;
                        log('âš ï¸ WebSocket ë¯¸ì—°ê²° - ê²°ê³¼ë¥¼ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'warn');
                    } else {
                        log('ğŸ”” ì¶”ì²œ ê²°ê³¼ ëŒ€ê¸° ì¤‘...', 'info');
                    }

                } else {
                    const error = await response.text();
                    log(`âŒ ìš”ì²­ ì‹¤íŒ¨: ${error}`, 'error');
                    
                    uploadStatus.innerHTML = `
                        <div style="background: #ffebee; padding: 15px; border-radius: 8px; border-left: 4px solid #f44336;">
                            <p style="color: #c62828; font-weight: 600;">âŒ ìš”ì²­ ì‹¤íŒ¨</p>
                            <p style="color: #555; font-size: 14px;">${error}</p>
                        </div>
                    `;
                }

            } catch (error) {
                log(`âŒ ìš”ì²­ ì˜¤ë¥˜: ${error.message}`, 'error');
                
                uploadStatus.innerHTML = `
                    <div style="background: #ffebee; padding: 15px; border-radius: 8px; border-left: 4px solid #f44336;">
                        <p style="color: #c62828; font-weight: 600;">âŒ ìš”ì²­ ì˜¤ë¥˜</p>
                        <p style="color: #555; font-size: 14px;">${error.message}</p>
                    </div>
                `;
                
            } finally {
                recommendBtn.disabled = false;
            }
        }

        // WebSocket ì—°ê²°
        function connectWebSocket() {
            if (!token) {
                alert('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.');
                return;
            }

            log('WebSocket ì—°ê²° ì‹œë„...', 'info');

            const socket = new SockJS(`${SERVER_URL}/ws?token=${encodeURIComponent(token)}`);
            stompClient = Stomp.over(socket);

            stompClient.connect({}, 
                function(frame) {
                    log('âœ… WebSocket ì—°ê²° ì„±ê³µ', 'success');
                    updateConnectionStatus(true);

                    // ì¶”ì²œ ê²°ê³¼ ì•Œë¦¼ êµ¬ë… (íŠ¹ì • íšŒì› IDë¡œ)
                    stompClient.subscribe(`/topic/recommand/${userId}`, function(message) {
                        log('ğŸ“¨ ì¶”ì²œ ê²°ê³¼ ì•Œë¦¼ ìˆ˜ì‹ ', 'info');
                        log('ğŸ“¦ ìˆ˜ì‹ í•œ ë©”ì‹œì§€: ' + message.body.substring(0, 100) + '...', 'info');
                        const parsedMessage = JSON.parse(message.body);
                        handleRecommendationResult(parsedMessage);
                    });

                    // Pong ì‘ë‹µ êµ¬ë…
                    stompClient.subscribe('/topic/pong', function(message) {
                        log(`ğŸ“ Pong ìˆ˜ì‹ : ${message.body}`, 'success');
                    });

                    log(`êµ¬ë… ì™„ë£Œ: /topic/recommand/${userId}`, 'success');
                },
                function(error) {
                    log(`âŒ WebSocket ì—°ê²° ì‹¤íŒ¨: ${error}`, 'error');
                    updateConnectionStatus(false);
                }
            );
        }

        // WebSocket ì—°ê²° ëŠê¸°
        function disconnectWebSocket() {
            if (stompClient) {
                stompClient.disconnect();
                log('WebSocket ì—°ê²° ì¢…ë£Œ', 'info');
                updateConnectionStatus(false);
            }
        }

        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateConnectionStatus(connected) {
            const statusDiv = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const pingBtn = document.getElementById('pingBtn');

            if (connected) {
                statusDiv.className = 'status connected';
                statusDiv.innerHTML = 'ğŸŸ¢ ì—°ê²°ë¨';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                pingBtn.disabled = false;
            } else {
                statusDiv.className = 'status disconnected';
                statusDiv.innerHTML = 'âš« ì—°ê²° ëŠê¹€';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                pingBtn.disabled = true;
            }
        }

        // ì¶”ì²œ ê²°ê³¼ ì²˜ë¦¬
        function handleRecommendationResult(result) {
            log('ğŸ“¨ ì¶”ì²œ ê²°ê³¼ ì²˜ë¦¬ ì‹œì‘: ' + JSON.stringify(result).substring(0, 200) + '...', 'info');
            
            notificationCount++;
            document.getElementById('notificationCount').textContent = notificationCount;

            const notificationsDiv = document.getElementById('notifications');
            
            if (notificationCount === 1) {
                notificationsDiv.innerHTML = '';
            }

            const notificationItem = document.createElement('div');
            const status = result.status || 'success';
            notificationItem.className = `notification-item ${status.toLowerCase()}`;

            const time = new Date(result.timestamp || Date.now()).toLocaleString('ko-KR');

            let bodyHTML = `<p><strong>ìƒíƒœ:</strong> ${status}</p>`;
            
            if (result.roomAnalysis) {
                bodyHTML += `<p><strong>ë°© ìŠ¤íƒ€ì¼:</strong> ${result.roomAnalysis.style || 'N/A'}</p>`;
                if (result.roomAnalysis.detectedFurniture && result.roomAnalysis.detectedFurniture.length > 0) {
                    bodyHTML += `<p><strong>ê°ì§€ëœ ê°€êµ¬:</strong> ${result.roomAnalysis.detectedFurniture.join(', ')}</p>`;
                }
            }
            
            if (result.recommendation) {
                bodyHTML += `<p><strong>ì¶”ì²œ ì¹´í…Œê³ ë¦¬:</strong> ${result.recommendation.targetCategory || 'N/A'}</p>`;
                bodyHTML += `<p><strong>ì¶”ì²œ ê°œìˆ˜:</strong> ${result.recommendation.resultCount || result.recommendation.results?.length || 0}ê°œ</p>`;
            }

            notificationItem.innerHTML = `
                <div class="notification-header">
                    <span class="notification-type">ì¶”ì²œ ê²°ê³¼ - ${status}</span>
                    <span class="notification-time">${time}</span>
                </div>
                <div class="notification-body">
                    ${bodyHTML}
                </div>
            `;

            notificationsDiv.insertBefore(notificationItem, notificationsDiv.firstChild);

            // ê²°ê³¼ í™”ë©´ ì—…ë°ì´íŠ¸
            const resultSection = document.getElementById('resultSection');
            const resultContent = document.getElementById('resultContent');
            
            if (result.roomAnalysis && result.recommendation && result.recommendation.results) {
                log('âœ… displayRecommendationResult í˜¸ì¶œ', 'success');
                displayRecommendationResult(result);
            } else {
                log('âš ï¸ í•„ìˆ˜ ë°ì´í„° ë¶€ì¡±: roomAnalysis=' + !!result.roomAnalysis + ', recommendation=' + !!result.recommendation, 'warn');
                
                resultContent.innerHTML = `
                    <div style="background: #fff3e0; padding: 30px; border-radius: 8px; text-align: center; border-left: 4px solid #ff9800;">
                        <p style="color: #e65100; font-weight: 600; font-size: 18px;">âš ï¸ ë¶„ì„ ì§„í–‰ ì¤‘</p>
                        <p style="color: #666; margin-top: 10px;">ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                        ${result.roomAnalysis ? `<p style="color: #666; font-size: 14px; margin-top: 15px;"><strong>ë°© ë¶„ì„:</strong> ${result.roomAnalysis.style || 'N/A'} ìŠ¤íƒ€ì¼</p>` : ''}
                    </div>
                `;
            }
            
            resultSection.style.display = 'block';

            // ë¸Œë¼ìš°ì € ì•Œë¦¼
            if (Notification.permission === 'granted') {
                const title = status === 'success' ? 'ğŸ‰ ê°€êµ¬ ì¶”ì²œ ì™„ë£Œ!' : 'âš ï¸ ì¶”ì²œ ì²˜ë¦¬ ì¤‘';
                const body = result.recommendation?.targetCategory 
                    ? `${result.recommendation.targetCategory} ì¶”ì²œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.` 
                    : 'ì¶”ì²œ ë¶„ì„ì„ ì²˜ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.';
                new Notification(title, { body });
            }
        }

        // ì¶”ì²œ ê²°ê³¼ í™”ë©´ì— í‘œì‹œ
        function displayRecommendationResult(result) {
            log('ğŸ¨ ì¶”ì²œ ê²°ê³¼ UI ë Œë”ë§ ì‹œì‘', 'info');
            
            const resultContent = document.getElementById('resultContent');
            const roomAnalysis = result.roomAnalysis;
            const recommendation = result.recommendation;

            if (!recommendation || !recommendation.results) {
                log('âŒ ì¶”ì²œ ë°ì´í„° ëˆ„ë½: recommendation=' + !!recommendation + ', results=' + !!(recommendation?.results), 'error');
                resultContent.innerHTML = `
                    <div style="background: #ffebee; padding: 30px; border-radius: 8px; text-align: center; border-left: 4px solid #f44336;">
                        <p style="color: #c62828; font-weight: 600; font-size: 18px;">âŒ ë°ì´í„° ì˜¤ë¥˜</p>
                        <p style="color: #666; margin-top: 10px;">ì¶”ì²œ ê²°ê³¼ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }

            let html = `<div class="recommendation-container">`;

            // ë°© ë¶„ì„ ê²°ê³¼ (ìˆìœ¼ë©´ í‘œì‹œ)
            if (roomAnalysis) {
                html += `
                    <div class="room-analysis">
                        <h3>ğŸ  ë°© ë¶„ì„ ê²°ê³¼</h3>
                        <div class="analysis-grid">
                            <div class="analysis-item">
                                <div class="analysis-item-label">ìŠ¤íƒ€ì¼</div>
                                <div class="analysis-item-value">${roomAnalysis.style || 'N/A'}</div>
                            </div>
                            <div class="analysis-item">
                                <div class="analysis-item-label">ìƒ‰ìƒ</div>
                                <div class="analysis-item-value">${roomAnalysis.color || 'N/A'}</div>
                            </div>
                            <div class="analysis-item">
                                <div class="analysis-item-label">ì¬ì§ˆ</div>
                                <div class="analysis-item-value">${roomAnalysis.material || 'N/A'}</div>
                            </div>
                            <div class="analysis-item">
                                <div class="analysis-item-label">ê°ì§€ëœ ê°€êµ¬</div>
                                <div class="analysis-item-value">${roomAnalysis.detectedCount || 0}ê°œ</div>
                            </div>
                        </div>`;
                
                if (roomAnalysis.detectedFurniture && roomAnalysis.detectedFurniture.length > 0) {
                    html += `
                        <div style="margin-top: 15px;">
                            <p style="color: #666; font-size: 12px; font-weight: 600; margin-bottom: 8px;">ê°ì§€ëœ ê°€êµ¬ ëª©ë¡</p>
                            <div class="detected-furniture">
                                ${roomAnalysis.detectedFurniture.map(f => `<span class="furniture-tag">${f}</span>`).join('')}
                            </div>
                        </div>`;
                }
                html += `</div>`;
            }

            // ì¶”ì²œ ì •ë³´
            html += `
                <div class="recommendation-info">
                    <h3>ğŸ’¡ ê°€êµ¬ ì¶”ì²œ ì •ë³´</h3>
                    <p><strong>ì¶”ì²œ ì¹´í…Œê³ ë¦¬:</strong> ${recommendation.targetCategory || 'N/A'}</p>`;
            
            if (recommendation.searchQuery) {
                html += `
                    <div class="search-query">
                        <strong>ğŸ” ê²€ìƒ‰ ì¿¼ë¦¬:</strong> ${recommendation.searchQuery}
                    </div>`;
            }
            
            if (recommendation.reasoning) {
                html += `
                    <div class="reasoning">
                        <strong>ğŸ“ ì¶”ì²œ ì´ìœ :</strong> ${recommendation.reasoning}
                    </div>`;
            }

            // ì¶”ì²œ ê°€êµ¬ ê²°ê³¼
            const resultsCount = recommendation.results ? recommendation.results.length : 0;
            html += `
                    <h3 style="margin-top: 20px; color: #667eea; font-size: 16px;">ğŸ›‹ï¸ ì¶”ì²œ ê°€êµ¬ (${resultsCount}ê°œ)</h3>`;

            if (recommendation.results && recommendation.results.length > 0) {
                html += `<div class="furniture-cards-container">`;
                
                recommendation.results.forEach(result => {
                    const rank = result.rank || recommendation.results.indexOf(result) + 1;
                    const score = result.score ? (result.score * 100).toFixed(1) : 'N/A';
                    const imagePath = result.image_path || result.imagePath || '';
                    const filename = result.filename || 'Unknown';
                    
                    log(`ğŸ›‹ï¸ ê°€êµ¬ ì¹´ë“œ ìƒì„±: ${filename}, score=${score}`, 'info');
                    
                    html += `
                        <div class="furniture-card">
                            <img src="${imagePath}" alt="${filename}" class="furniture-card-image" onerror="this.src='https://via.placeholder.com/200x150?text=No+Image'">
                            <div class="furniture-card-body">
                                <span class="furniture-rank">ğŸ¥‡ Rank #${rank}</span>
                                <span class="furniture-score">ìœ ì‚¬ë„: ${score}%</span>
                                <div class="furniture-name">${filename}</div>
                            </div>
                        </div>`;
                });
                
                html += `</div>`;
            } else {
                html += `
                    <div class="no-recommendations">
                        <p>ì¶”ì²œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>`;
            }

            html += `
                </div>
            </div>`;

            resultContent.innerHTML = html;
            log('âœ… ì¶”ì²œ ê²°ê³¼ UI ë Œë”ë§ ì™„ë£Œ', 'success');
        }

        // Ping ì „ì†¡
        function sendPing() {
            if (!stompClient || !stompClient.connected) {
                alert('WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            stompClient.send('/app/ping', {}, '');
            log('ğŸ“ Ping ì „ì†¡', 'info');
        }

        // ì•Œë¦¼ ì§€ìš°ê¸°
        function clearNotifications() {
            const notificationsDiv = document.getElementById('notifications');
            notificationsDiv.innerHTML = '<p style="color: #999; text-align: center;">ìˆ˜ì‹ ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            notificationCount = 0;
            document.getElementById('notificationCount').textContent = '0';
            log('ì•Œë¦¼ ëª¨ë‘ ì‚­ì œ', 'info');
        }

        // ë¡œê·¸ ì§€ìš°ê¸°
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        // ì´ˆê¸°í™”
        log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ', 'success');
        log('Spring Boot ì„œë²„ URL: ' + SERVER_URL, 'info');
        
        // ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
        if (Notification.permission === 'default') {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    log('âœ… ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ í—ˆìš©ë¨', 'success');
                }
            });
        }
    </script>
</body>
</html>
